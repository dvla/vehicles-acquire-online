@(data: models.CompleteAndConfirmViewModel,
  dateService: uk.gov.dvla.vehicles.presentation.common.services.DateService)(implicit lang: Lang,
  token: uk.gov.dvla.vehicles.presentation.common.filters.CsrfPreventionAction.CsrfPreventionToken,
  config: utils.helpers.Config)

@import scala.collection.mutable.LinkedHashMap
@import uk.gov.dvla.vehicles.presentation.common
@import common.mappings.Mileage
@import common.views.html.widgets.dates.inputDayMonthYearTextbox
@import common.views.html.widgets.base.csrfTokenHiddenField
@import common.views.helpers.BaseTemplate.fieldConstructor
@import common.views.html.widgets.base.{valtechInputText, valtechDeclareCheck}
@import common.views.helpers.LabelHelper.optionalFieldKey
@import common.views.html.widgets.playbackList
@import models.CompleteAndConfirmFormModel.Form.{MileageId, ConsentId, DateOfSaleId, TodaysDateId}
@import views.acquire.CompleteAndConfirm.{BackId, SubmitId, modify}
@import views.html.common.vehicle_detail_playback
@import views.html.helper.form

@main(
    progress = Some(Messages("acquire_progress_8")),
    title = Messages("acquire_completeAndConfirm.title"),
    currentForm = Some(data.form),
    backButton = Some(controllers.routes.VehicleTaxOrSorn.present())
) {
   
    <h1>@Messages("acquire_completeAndConfirm.title")</h1>

    @* TODO: this should be removed as it will be put into the global scope by common *@
    <script src="@controllers.StaticAssets.versioned(config.assetsUrl)("lib/vehicles-presentation-common/javascripts/autofill-todays-date.js")" type="text/javascript"></script>

    @if(data.isSaleDateBeforeDisposalDate) {

        <div class="site-overlay"></div>

    }

    @form(action = data.submitAction) {

    <div class="two-col clearfix acquire-complete-confirm">
    
        <div class="first-col">
            @playbackList(
                Messages("acquire_completeandconfirm.newkeeperDetails"),
                {
                    val playbackItems: LinkedHashMap[String, String] = LinkedHashMap()
                    playbackItems += (Messages("acquire_completeandconfirm.displayName") -> data.keeperDetails.displayName)
                    playbackItems += (Messages("acquire_completeandconfirm.address") -> data.keeperDetails.address.address.mkString("<br/>"))
                    playbackItems += (Messages("acquire_completeandconfirm.email") -> data.keeperDetails.email.getOrElse(Messages("acquire_vehicleTaxOrSorn.emailNotEntered")))
                    if(data.keeperDetails.isBusinessKeeper)
                        playbackItems += (Messages("acquire_completeandconfirm.fleetNumber") -> data.keeperDetails.fleetNumber.getOrElse(Messages("acquire_completeandconfirm.fleetNumberNotEntered")))
                    else
                        playbackItems
                }
            )()
            @vehicle_detail_playback(data.vehicleAndKeeperDetails)
        </div>

        <div class="second-col">

                @csrfTokenHiddenField()

                @valtechDeclareCheck(
                    data.form(ConsentId),
                    args = modify(Map(
                        '_showConstraints -> false,
                        '_label -> Messages("acquire_keeperdetailscomplete.consent")
                    ), data.isSaleDateBeforeDisposalDate)
                )

                @if(data.isSaleDateBeforeDisposalDate) {
                    <div class="popup-modal">
                        <p>@Messages("acquire_completeandconfirm.dateofsale.warning", data.dateOfDisposal.getOrElse("NOT FOUND"))</p>
                        <div id=@DateOfSaleId>
                        @inputDayMonthYearTextbox(
                            field = data.form(DateOfSaleId),
                            args = Map(
                                '_label -> Messages("acquire_completeAndConfirm.dateofsale.label")
                            ),
                            dateService = dateService,
                            showTodaysDateButton = true,
                            showTodaysDateButtonId = Some(TodaysDateId),
                            hintText = Some(Messages("acquire_completeandconfirm.dateofsale.hint"))
                        )
                        </div>

                        <div class="form-steps">
                            <button id="@SubmitId"
                            type="submit"
                            name="action"
                            class="button">
                            @Messages("acquire_completeAndConfirm.submitbutton")
                            </button>
                            <br/>
                            <a class="back" id="@BackId" href="@controllers.routes.VehicleTaxOrSorn.present()">
                            @Messages("acquire_completeAndConfirm.backbutton")
                            </a>
                        </div>
                    </div>
                }

                <div id=@DateOfSaleId class="form-steps">
                    @if(data.isSaleDateBeforeDisposalDate) {
                        @inputDayMonthYearTextbox(
                            field = data.form(DateOfSaleId),
                            args = Map(
                                'tabindex -> -1,
                                '_label -> Messages("acquire_completeAndConfirm.dateofsale.label")
                            ),
                            dateService = dateService,
                            showTodaysDateButton = true,
                            showTodaysDateButtonId = Some(TodaysDateId),
                            hintText = Some(Messages("acquire_completeandconfirm.dateofsale.hint"))
                        )
                    } else {
                        @inputDayMonthYearTextbox(
                            field = data.form(DateOfSaleId),
                            args = Map(
                                '_label -> Messages("acquire_completeAndConfirm.dateofsale.label")
                            ),
                            dateService = dateService,
                            showTodaysDateButton = true,
                            showTodaysDateButtonId = Some(TodaysDateId),
                            hintText = Some(Messages("acquire_completeandconfirm.dateofsale.hint"))
                        )
                    }
                </div>

                @valtechInputText(
                    data.form(MileageId),
                    args = modify(Map('_label -> Messages("acquire_completeAndConfirm.mileage.label"),
                        '_showConstraints -> false,
                        'typeTel -> true,
                        'maxLength -> Mileage.MaxLength, // Must be set independently of the pattern as the pattern is only checked when the user submits.
                        'optionalFieldKey -> true
                        //'title -> Messages("acquire_keeperdetailscomplete.mileage.validation")
                    ) ++
                    (if(config.isHtml5ValidationEnabled) Map('pattern -> Mileage.Pattern) else Nil), data.isSaleDateBeforeDisposalDate)
                )

                <div class="form-steps">
                    <button id="@SubmitId"
                        type="submit"
                        name="action"
                        @if(data.isSaleDateBeforeDisposalDate) {tabindex="-1"}
                        class="button">
                        @Messages("acquire_completeAndConfirm.submitbutton")
                    </button>

                </div>
        </div>
    </div>
    }
    
    <script src="@controllers.StaticAssets.versioned(config.assetsUrl)("javascripts/firefox-dont-cache-page.js")" type="text/javascript"></script>
}
